from http import HTTPStatus
import dashscope
import os


dashscope.api_key = ""


def generate_summary_and_keywords(notification_content):
    # 构建请求内容，明确要求返回指定格式的摘要和关键词
    messages = [
        {'role': 'user',
         'content': f'请从以下内容生成摘要(100字以内)并提取关键词(最多三个关键词，请提取最主要的)，'
                    f'涉及哈尔滨工业大学的非专有词表述均使用‘我校’，'
                    f'返回数据格式为（输出纯json）：{{"keywords":[], "abstract":""}}。\n\n内容：{notification_content}'}
    ]
    response = dashscope.Generation.call("qwen-max",
                                          messages=messages,
                                          result_format='message',
                                          stream=False,
                                          incremental_output=False
                                          )

    abstract = ""
    keywords = []
    if response.status_code == HTTPStatus.OK:
        content = response.output.choices[0]['message']['content']
        # 假设API直接返回json格式的内容，使用eval转换成Python字典
        try:
            result = eval(content[8:-3])
            abstract = result.get("abstract", "")
            keywords = result.get("keywords", [])
        except Exception as e:
            print(f"Error parsing response: {e}")
            print(f"Response content: {content}")
            abstract = "AI概括暂不可用"
    else:
        print(f'Request id: {response.request_id}, Status code: {response.status_code}, '
              f'error code: {response.code}, error message: {response.message}')

    # 返回指定格式的结果
    return {
        "keywords": keywords,
        "abstract": abstract.strip()  # 去除多余的空格
    }


if __name__ == '__main__':
    notification = "各学院、学部： “大学生创新训练计划”（以下简称大创计划）是我校创新创业教育体系的重要组成部分，也是落实我校“以学生为中心，学生学习与发展成效驱动”教育理念的重要载体。根据《哈尔滨工业大学大学生创新创业训练计划管理办法》（以下简称管理办法）(附件1）规定，学校现组织开展2024年秋季学期大创计划项目的立项、结题及评奖工作。现将相关事宜通知如下： 一、立项申请 （一）申报条件 根据管理办法规定，大创计划项目分为创新训练项目、创业训练项目和创业实践项目三类。创新训练项目和创业训练项目申请者仅限本科生个人或团队。创业实践项目以本科生团队为主，可包括已成为研究生的前期项目成员。每人限主持或参加一个项目，不得在不同项目之间交叉申报。正在承担（含主持和参加）项目的学生不能再申报新项目。 （二）立项说明 1.大创计划项目分为国家级、省级和校级。本学期大创计划项目全部按照校级项目立项，下一年度春季学期中期检查后，项目所在学院、学部（以下简称学院）择优向学校推荐参加学校开展的国家级、省级项目遴选，经学校评审后择优向上级部门推荐国家级、省级项目。国家级、省级项目的最终确认名单以教育部和省教育厅公示文件为准。 2.教育部“国创计划”设立重点支持项目，主要面向世界科技前沿、面向经济主战场、面向国家重大需求、面向人民生命健康，鼓励引导大学生围绕基础学科以及新工科、新医科、新农科、新文科等关键领域开展创新实践。学校鼓励各位老师和同学积极在重点支持项目领域中选题申报。 3.教育部“国创计划”设立“华为企业命题项目”，华为技术有限公司可为申报团队提供相关技术指导和算力资源支持，具体题目介绍及联系方式见附件2，申请“华为企业命题”的大创计划项目时，请在题目最后加入（华为）字样。 （三）申报要求 1.学生申请。项目负责人登录本科教学管理与服务平台（http://jwts.hit.edu.cn）（以下简称管理平台），在创新创业栏目下的大创项目申报功能中填写立项申请、邀请同组组员加入项目并保存，待组员登录管理平台接受邀请后项目负责人方可提交项目申请。 2.学院组织评审。大创计划项目立项一般采用答辩形式进行。学院按照管理平台中的申请名单组织学生立项答辩（答辩时间和地点由学院安排）。立项答辩专家由学院专职教师担任，答辩小组（不少于3人）在答辩完成后将答辩会议纪要〔包含答辩时间、地点、专家名单、记录人、学生答辩情况、专家意见、答辩结果（附答辩项目表）、专家签字〕（会议纪要模板见附件3）提交给学院保存（保存至学生毕业后3年）。答辩会议纪要经学院确认并盖公章后，由学院教学秘书将扫描件发至教务处联系人邮箱作为学院年度大创计划项目绩效考评的依据。 3.立项材料上传及审核。学生答辩通过后，将按照专家提出意见修改后的最终版立项申请书（见附件4）上传至管理平台，学院对完成上传立项申请书的项目进行审核。请各学院于10月9日前在管理平台（C/S端）中完成立项审核工作。 二、结题验收 1.学院组织结题验收 学院对学生前期立项并已通过中期检查的大创计划项目组织开展结题验收工作，结题验收应以答辩形式进行，项目负责人须参加学院组织的结题验收答辩（具体时间和地点由学院安排）。答辩可分组进行，专家由学院专职教师担任，各答辩组（不少于3人）在答辩完成后将答辩会议纪要〔包含答辩时间、地点、专家名单、记录人、学生答辩情况、专家意见、答辩结果（附答辩项目表）、专家签字〕（会议纪要模板见附件5）提交给学院保存（保存至学生毕业后3年）。答辩会议纪要经学院确认并盖公章后，由学院教学秘书将扫描件发至教务处联系人邮箱作为学院年度大创计划项目绩效考评的依据。 2.学生上传结题报告 结题验收答辩通过后，学生登录管理平台上传结题报告〔点击创新创业→大创项目申报及报告上传→开始申报→立项学期→对应项目上传结题报告→填写与该项目有关的成果（包括论文、专利、竞赛获奖、创办公司情况）→上传项目的结题验收书（见附件6）→点击提交→完成结题报告上传〕。 请各学院于10月9日前在管理平台（C/S端）中完成结题验收项目审批。 3.项目延期或终止申请 学生因客观原因不能在规定期限按计划结题而延期的项目，项目负责人应撰写项目进展报告（附件7），详细阐明延期的缘由，经指导教师签署意见后，提交到学院教学秘书处。原则上每个项目只能申请一次延期，延期时间不得超过一年。因无法克服原因终止项目需在管理平台提交项目终止申请，终止项目成员当学期不允许重新立项。所有项目异动在管理平台中申请后均需指导教师在管理平台中创新创业栏目下的项目异动审核功能中审批，审核通过后提交至学院，学院审核通过方可生效。原则上中期检查结束后不应再变更项目成员、题目及内容。 三、优秀项目评奖 按照管理办法规定，学校设立大创计划优秀项目奖，由学院组织评选，奖励分一等奖和二等奖，获奖总数量不超过本次结题项目的30%，其中一等奖数量不超过10%。评选结束后学院须在校园网进行公示（公示期至少三天），公示无异议后由教学秘书于10月9日前在管理平台（C/S端）（点击菜单：创新创业-大创计划-获奖信息录入）中提交推荐获奖项目名单。获奖项目应制作“哈尔滨工业大学大学生创新训练计划优秀项目展板”（模板见附件8）提交至学院，学院应在公示结束后的15个工作日内将优秀项目展板电子版材料发送至指定邮箱。学校将形成优秀项目资料库定期进行推介及展示。 四、其他要求及说明 1.学院组织召开宣讲会 学生立项前，学院须召开立项宣讲会。邀请资深大创计划项目指导教师及管理人员宣讲申报要求、项目选题、实施过程及学校政策等内容，同时可邀请往年大创计划优秀项目学生到会介绍经验和心得。学院应在校园网及“创-HIT”公众号上提前发布会议通知，并于会后发布新闻，会议应以“创新创业讲坛”为标题，“创新创业讲坛”申请流程见网址：http://hituc.hit.edu.cn/2020/1110/c17846a325396/page.htm。宣讲会后填写《大学生创新训练计划宣讲情况统计表》（附件9），将电子版发至指定邮箱。 2.经费支持 学校对大创计划项目按照不同级别分别给予经费支持，支持标准及比例按照相关规定执行。 3.激励政策 学校为结题项目和获奖项目颁发荣誉证书，并经过遴选择优推荐国家级大创计划项目参加全国大学生创新年会，所获奖项将按学校相关规定获得创新创业学分或在推荐免试研究生时给予加分。 五、联系方式 办公地点：格物楼705室 联 系 人：凌凯隆，电话：86403228 电子邮箱：lkl@hit.edu.cn 附件：1.哈尔滨工业大学大学生创新创业训练计划管理办法 2.华为企业命题题目介绍及联系方式 3.XX学院大学生创新训练计划项目立项答辩会议纪要 4.哈尔滨工业大学大学生创新训练计划立项申请书 5.XX学院大学生创新训练计划项目结题验收答辩会议纪要 6.哈尔滨工业大学大学生创新训练计划项目验收书 7.哈尔滨工业大学大学生创新训练计划项目进展报告 8.哈尔滨工业大学大学生创新训练计划优秀项目展板（样式） 9.哈尔滨工业大学大学生创新训练计划宣讲情况统计表"
    result = generate_summary_and_keywords(notification)
    print("AI概括摘要与关键词:", result)
